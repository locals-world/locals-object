<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../locals-icon/locals-icon.html">
<link rel="import" href="../locals-button/locals-button.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="locals-objectlayer.html">

<!--
Abstraction of a locals object with configurable layers.

Example:

    <locals-object></locals-object>
Example:
<locals-object>
<h2>Hello locals-object</h2>
</locals-object>
@demo demo/index.html
-->
<dom-module id="locals-object">
<template>
  <style>
      :host {
        display: block;
        box-sizing: border-box;
        position: relative;

        --obj-width:300px;
        --obj-height:450px;

      }


      .total {
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-center);      
      }

      .arrowsandobject {
        height: var(--obj-height);  
        @apply(--layout-vertical);
        @apply(--layout-center);
      }

      .objectcanvas {
        width: var(--obj-width);
        height: var(--obj-height);  
      }

      .objectarrows {
        width: var(--obj-width);
      }
      
      .absolutepos {
        position: absolute;
        width: var(--obj-width);
        height: var(--obj-height);  
      }

      locals-objectlayer {
        width: 100%;
        height: 100%;
      }

      .editbtns {
        z-index: 10;
        width: var(--obj-width);
        height: var(--obj-height);  
        @apply(--layout-horizontal);
      }

      .editbtn {
        width: 50%;
        height: 100%;
      }

      .left {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .right {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-end-justified);
      }


      locals-icon {
        background-color: rgba(0,0,0,0.05);
        border-radius: 50%;
        box-sizing: border-box;
        padding: 10px;
      }


      .layeritems {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);

        @apply(--layout-wrap);
        width: 100%;
      }

      .layeritem {
        width: 50px;
        height: 50px;
        border:2px solid transparent;
        border-radius: 50%;
      }


      .iron-selected {
        border:2px solid pink;
      }
      .layeritem img {
        width: 100%;
        height: 100%;
      }

      .btns {
        @apply(--layout-horizontal);
        @apply(--layout-center-center); 
        width: 100%;
        padding-top: 20px;         
      }

      .btns locals-button {
        margin: 5px;
      }

    </style>

<div class="total">

<div class="arrowsandobject">
  <template is="dom-if" if="{{_isMode(mode,'edit')}}">
  <div class="objectarrows">
    <div class="absolutepos editbtns">
      <div class="editbtn left">
        <locals-icon iconcolor="darkgrey" on-tap="prev" icon="arrowleft"></locals-icon>
      </div>
      <div class="editbtn right">
        <locals-icon iconcolor="darkgrey" on-tap="next" icon="arrowright"></locals-icon>
      </div>
    </div>
  </div>
  </template>

  <div class="objectcanvas">
    <template is="dom-repeat" items="{{config.layers}}" >
      <div class="absolutepos" on-tap="_toEdit">
        <locals-objectlayer options="[[_filterOptions(index,item.options,_selectedgroup)]]" selected="[[_arrayItem(internalstate.*,index)]]" editmode="[[_isMode(mode,'edit')]]" inanimation="{{inanimation}}" outanimation="{{outanimation}}"></locals-objectlayer>
      </div>
    </template>
  </div>
</div>
  <div class="layerselector">
    <template is="dom-if" if="{{_isMode(mode,'edit')}}">
      <template is="dom-if" if="{{multilayer}}">
        <iron-selector selected="{{_selectedlayer}}" class="layeritems">
          <template is="dom-repeat" items="{{config.layers}}" >

          <div class="layeritem" on-tap="selectlayer" data-args$="{{index}}"><img src="{{item.icon}}"></div>
          </template>
        </iron-selector>
      </template>

      <template is="dom-if" if="{{_hasGroups(_selectedlayer)}}">
        <iron-selector selected="{{_selectedgroup}}">
          <template is="dom-repeat" items="{{_getGroups(_selectedlayer)}}" >
            <h4>
              <div on-tap="selectgroup" class="{{item.class}}" data-args$="{{item}}">{{item.name}}</div>
            </h4>
          </template>
        </iron-selector>
      </template>

      <div class="btns">
        <locals-button iconcolor="darkgrey" on-tap="_save" icon="v"></locals-button>
        <locals-button iconcolor="darkgrey" on-tap="_discard" icon="decline"></locals-button>
      </div>
    </template>
  </div>
</div>
</template>

<script>
    Polymer({
      is: 'locals-object',

      properties: {
        /**
         * `config` is the internal configuration and internalstate of the object
         */
        config: {
          type: Object
        },

        state: {
          type: Object,
          notify: true
        },

        // `mode` is either 'view' or 'edit'
        mode: {
          type:String,
          value: "view"
        },

        _selectedlayer: {
          type: Number,
          value :0
        },
        _selectedgroup: {
          type: Number,
           value :0
        }
      },

      _arrayItem: function(change, index) {
        return change.base[index];
      },

      // Element Lifecycle

      ready: function() {
      },

      attached: function() {
        this.internalstate = this._clone(this.state);
        this.multilayer = this.config.layers.length > 1;
      },

      // select a different layer
      selectlayer: function(e){
        this._selectedlayer = e.target.getAttribute('data-args');
      },

      // select previous item in current layer, rolls around if you're at the beginning
      prev: function() {
        this.inanimation = 'slide-from-right-animation';
        this.outanimation = 'slide-left-animation';

        if (this.internalstate[this._selectedlayer] == 0) {
          this.set('internalstate.' + this._selectedlayer, this.config.layers[this._selectedlayer].options.length - 1);

        } else {
          this.set('internalstate.' + this._selectedlayer, this.internalstate[this._selectedlayer] - 1);
        }
      },

      next: function() {

        this.inanimation = 'slide-from-left-animation';
        this.outanimation = 'slide-right-animation';

        if (this.internalstate[this._selectedlayer] == this.config.layers[this._selectedlayer].options.length - 1) {
          this.set('internalstate.' + this._selectedlayer, 0);
        } else {
          this.set('internalstate.' + this._selectedlayer, this.internalstate[this._selectedlayer] + 1);
        }
      },

      _hasGroups: function(layer){
        return this.config.layers[layer].colors || this.config.colors;
      },

      _getGroups: function(layer){
        var groups = this.config.layers[layer].colors || this.config.colors;
        if (!groups){
          return;
        }
//        var g = Object.keys(groups).map(function (key) {return ({key:key,val:groups[key]}); }); ;
//        return g;
        return groups;
      },

      selectgroup: function(e){
        this._selectedGroup = e.target.getAttribute('data-args');
      },

      _getGroup: function(){
        if (!this._hasGroups(this._selectedlayer)){
          return;
        }
        return this._selectedGroup;
      },

      _groupFilter: function(options, _selectedGroup) {
        var g = options.map(function(val) {

          console.log(val);
          //          return ({key:key,val:groups[key]}); }); ;
          return val;
        });
        return g;

      },
      _filterOptions: function(layer,options,selectedgroup){
        if (layer != this._selectedlayer){
          return options;
        }
        var self=this;
        var selectedoptions = [];
        options.forEach(function(option){
          if (!option.group || option.group == self.config.colors[selectedgroup].name){
            selectedoptions.push(option);
          }
        });
        return selectedoptions;
      },

      _clone: function(obj) {
          if (null == obj || "object" != typeof obj) return obj;
          var copy = obj.constructor();
          for (var attr in obj) {
              if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
          }
          return copy;
      },


      detached: function() {
      },

      _isMode: function(a,b){
        return a==b;
      },

      _toEdit: function(){
        this.mode = "edit";
        this._oldinternalstate = {};
        this._oldinternalstate = this._clone(this.internalstate);
      },

      _toView: function(){
        this.mode = "view";
      },

      _save: function(){
        this.state = this._clone(this.internalstate);
        this._toView();
      },

      _discard: function(){
        this.internalstate = this._clone(this._oldinternalstate);
        this._toView();
      }

      // Element Behavior

    
    });
  </script>
</dom-module>